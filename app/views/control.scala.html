@(username: String)

<!DOCTYPE html>

<html>
    <head>
        <title>Controller</title>
        <meta charset=utf-8>
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0," /> 
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("bootstrap/css/bootstrap.min.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
        <script src="@routes.Assets.at("javascripts/jquery-1.7.1.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/mustache.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/main.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/Vector2.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/ShipMovingTouch.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("javascripts/BulletSebs.js")" type="text/javascript"></script>

        <style type="text/css"> 
    
            * {
              -webkit-touch-callout: none; /* prevent callout to copy image, etc when tap to hold */
              -webkit-text-size-adjust: none; /* prevent webkit from resizing text to fit */
              -webkit-tap-highlight-color: rgba(0,0,0,0); 
              -webkit-user-select: none; /* prevent copy paste, to allow, change 'none' to 'text' */
              -webkit-tap-highlight-color: rgba(0,0,0,0); 
            }
            
            body {
                background-color: #000000;
                margin: 0px;
            }
            canvas {
                display:block; 
                position:absolute; 
            }
            .container {
                width:auto;
                text-align:center;
                background-color:#ff0000;
            }
        </style>
    </head>
    <body>
        <script>

            var canvas,
            c, // c is the canvas' context 2D
            container, 
            halfWidth, 
            halfHeight,
            leftTouchID = -1, 
            leftTouchPos = new Vector2(0,0),
            leftTouchStartPos = new Vector2(0,0),
            leftVector = new Vector2(0,0); 

            var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket    
            var socket = new WS( "ws://" + location.host + "/mobile/@username/stream " )

            var x = 0
            var y = 0

            var websocketCapable = true
            if (!window.WebSocket) {
                websocketCapable = false
            }

            setupCanvas();

            var mouseX, mouseY, 
                // is this running in a touch capable environment?
                touchable = 'createTouch' in document,
                touches = [], // array of touch vectors
                ship = new ShipMoving(halfWidth, halfHeight)
                bullets = [],
                spareBullets = [];
                
                
            setInterval(draw, 1000/50); 


            if(touchable) {
                canvas.addEventListener( 'touchstart', onTouchStart, false );
                canvas.addEventListener( 'touchmove', onTouchMove, false );
                canvas.addEventListener( 'touchend', onTouchEnd, false );
                window.onorientationchange = resetCanvas;  
                window.onresize = resetCanvas;  
                //window.onscroll = resetCanvas;  
            }

            function resetCanvas (e) {  
                // resize the canvas - but remember - this clears the canvas too. 
                canvas.width = window.innerWidth + 100; 
                canvas.height = window.innerHeight + 100;
                
                halfWidth = canvas.width/2; 
                halfHeight = canvas.height/2;
                
                //make sure we scroll to the top left. 
                window.scrollTo(0,0); 
            }

            function draw() {
              
                c.clearRect(0,0,canvas.width, canvas.height); 

                //socket.send( JSON.stringify( { action: "moving", name: "@username", controlx: x, controly: y } ) )
                move(x, y)

                if(touchable) {
                
                    for(var i=0; i<touches.length; i++) {
                        
                        var touch = touches[i]; 
                        
                        if(touch.identifier == leftTouchID){
                            c.beginPath(); 
                            c.strokeStyle = "blue"; 
                            c.lineWidth = 6; 
                            c.arc(leftTouchStartPos.x, leftTouchStartPos.y, 40,0,Math.PI*2,true); 
                            c.stroke();
                            c.beginPath(); 
                            c.strokeStyle = "blue"; 
                            c.lineWidth = 2; 
                            c.arc(leftTouchStartPos.x, leftTouchStartPos.y, 60,0,Math.PI*2,true); 
                            c.stroke();
                            c.beginPath(); 
                            c.strokeStyle = "cyan"; 
                            c.arc(leftTouchPos.x, leftTouchPos.y, 40, 0,Math.PI*2, true); 
                            c.stroke(); 
                            c.beginPath(); 
                            c.strokeStyle = "blue"; 
                            c.lineWidth = 1;
                            c.moveTo(leftTouchStartPos.x, leftTouchStartPos.y)
                            c.lineTo(leftTouchPos.x, leftTouchPos.y)
                            c.strokeStyle = "blue"; 
                            c.moveTo(leftTouchPos.x - 40, leftTouchPos.y)
                            c.lineTo(leftTouchPos.x + 40, leftTouchPos.y)
                            c.moveTo(leftTouchPos.x, leftTouchPos.y +  40)
                            c.lineTo(leftTouchPos.x, leftTouchPos.y - 40)
                            c.stroke()
                        } else {
                            c.beginPath(); 
                            c.strokeStyle = "red";
                            c.lineWidth = "6";
                            c.arc(touch.clientX, touch.clientY, 40, 0, Math.PI*2, true); 
                            c.stroke();
                        }
                    }
                }
            }

            function onTouchStart(e) {
             
                for(var i = 0; i<e.changedTouches.length; i++){
                    var touch =e.changedTouches[i]; 
                    if((leftTouchID<0) && (touch.clientX<halfWidth)) {
                        //socket.send( JSON.stringify( { action: "moving", name: "@username", controlx: leftVector.x, controly: leftVector.y } ) )
                        x = leftVector.x
                        y = leftVector.y
                        leftTouchID = touch.identifier; 
                        leftTouchStartPos.reset(touch.clientX, touch.clientY);  
                        leftTouchPos.copyFrom(leftTouchStartPos); 
                        leftVector.reset(0,0); 
                        continue;       
                    } else {
                        //socket.send( JSON.stringify( { action: "fire", name: "@username", padx: touch.clientX, pady: touch.clientY } ) )
                        fire(touch.clientX, touch.clientY)
                    }   
                }
                touches = e.touches; 
            }
             
            function onTouchMove(e) {
                 // Prevent the browser from doing its default thing (scroll, zoom)
                e.preventDefault();
                for(var i = 0; i<e.changedTouches.length; i++){
                    var touch =e.changedTouches[i]; 
                    if(leftTouchID == touch.identifier)
                    {
                        leftTouchPos.reset(touch.clientX, touch.clientY); 
                        leftVector.copyFrom(leftTouchPos); 
                        leftVector.minusEq(leftTouchStartPos);  
                        //socket.send( JSON.stringify( { action: "moving", name: "@username", controlx: leftVector.x, controly: leftVector.y } ) )
                        x = leftVector.x
                        y = leftVector.y
                        break;      
                    }       
                }
                touches = e.touches;     
            } 
             
            function onTouchEnd(e) { 
                touches = e.touches; 
                for(var i = 0; i<e.changedTouches.length; i++){
                    var touch =e.changedTouches[i]; 
                    if(leftTouchID == touch.identifier)
                    {
                        leftTouchID = -1; 
                        leftVector.reset(0,0); 
                        x = 0
                        y = 0
                        break;      
                    }       
                }
            }

            function setupCanvas() {
                
                canvas = document.createElement( 'canvas' );
                c = canvas.getContext( '2d' );
                container = document.createElement( 'div' );
                container.className = "container";

                document.body.appendChild( container );
                container.appendChild(canvas);  

                resetCanvas(); 
                
                c.strokeStyle = "#ffffff";
                c.lineWidth =2; 
            }

            function move(vx, vy) {
                var message = JSON.stringify( { action: "moving", name: "@username", controlx: vx, controly: vy } )
                if (websocketCapable) {
                    socket.send( message )
                } else {
                    $.post("@routes.Application.padAction(username)", { message: message })
                }
            }

            function fire(vx, vy) {
                var message = JSON.stringify( { action: "fire", name: "@username", padx: vx, pady: vy } )
                if (websocketCapable) {
                    socket.send( message )
                } else {
                    $.post("@routes.Application.padAction(username)", { message: message })
                    routes
                }
            }
        </script>
    </body>
</html>